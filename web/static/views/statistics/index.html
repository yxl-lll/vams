<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æœåŠ¡ç»Ÿè®¡æŠ¥è¡¨</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        .stats-cards { margin-bottom: 20px; }
        .stats-card { 
            text-align: center; 
            padding: 20px; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stats-number { 
            font-size: 32px; 
            font-weight: bold; 
            color: #5FB878; 
            margin: 10px 0; 
        }
        .stats-label { 
            color: #666; 
            font-size: 14px; 
        }
        .chart-container { 
            background: #fff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .search-box { margin: 15px 0; }
        .export-buttons { margin: 15px 0; }
    </style>
</head>
<body>
    <div class="layui-fluid">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="layui-row layui-col-space15 stats-cards">
            <div class="layui-col-md3">
                <div class="stats-card">
                    <i class="layui-icon layui-icon-user" style="font-size: 24px; color: #5FB878;"></i>
                    <div class="stats-number" id="totalVolunteers">0</div>
                    <div class="stats-label">æ€»å¿—æ„¿è€…æ•°</div>
                </div>
            </div>
            <div class="layui-col-md3">
                <div class="stats-card">
                    <i class="layui-icon layui-icon-trademark" style="font-size: 24px; color: #1E9FFF;"></i>
                    <div class="stats-number" id="totalActivities">0</div>
                    <div class="stats-label">æ€»æ´»åŠ¨æ•°</div>
                </div>
            </div>
            <div class="layui-col-md3">
                <div class="stats-card">
                    <i class="layui-icon layui-icon-time" style="font-size: 24px; color: #FFB800;"></i>
                    <div class="stats-number" id="totalServiceHours">0</div>
                    <div class="stats-label">æ€»æœåŠ¡æ—¶é•¿(å°æ—¶)</div>
                </div>
            </div>
            <div class="layui-col-md3">
                <div class="stats-card">
                    <i class="layui-icon layui-icon-ok-circle" style="font-size: 24px; color: #FF5722;"></i>
                    <div class="stats-number" id="completedActivities">0</div>
                    <div class="stats-label">å·²å®Œæˆæ´»åŠ¨</div>
                </div>
            </div>
        </div>

        <!-- æœç´¢æ¡ä»¶ -->
        <div class="search-box">
            <form class="layui-form" lay-filter="searchForm">
                <div class="layui-inline">
                    <label class="layui-form-label">ç»Ÿè®¡æ—¶é—´</label>
                    <div class="layui-input-inline">
                        <input type="text" name="start_date" id="startDate" placeholder="å¼€å§‹æ—¥æœŸ" class="layui-input">
                    </div>
                    <div class="layui-form-mid">-</div>
                    <div class="layui-input-inline">
                        <input type="text" name="end_date" id="endDate" placeholder="ç»“æŸæ—¥æœŸ" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <select name="activity_type">
                        <option value="">å…¨éƒ¨æ´»åŠ¨ç±»å‹</option>
                        <option value="ç¯ä¿">ç¯ä¿</option>
                        <option value="æ•™è‚²">æ•™è‚²</option>
                        <option value="åŒ»ç–—">åŒ»ç–—</option>
                        <option value="æ–‡åŒ–">æ–‡åŒ–</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="layui-inline">
                    <button class="layui-btn" lay-submit lay-filter="search">æŸ¥è¯¢ç»Ÿè®¡</button>
                    <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®</button>
                </div>
            </form>
        </div>

        <!-- å¯¼å‡ºæŒ‰é’® -->
        <div class="export-buttons">
            <button class="layui-btn layui-btn-normal" id="exportExcel">
                <i class="layui-icon layui-icon-export"></i> å¯¼å‡ºExcel
            </button>
            <button class="layui-btn layui-btn-warm" id="exportPDF">
                <i class="layui-icon layui-icon-file"></i> å¯¼å‡ºPDF
            </button>
        </div>

        <!-- å›¾è¡¨å®¹å™¨ -->
        <div class="layui-row layui-col-space15">
            <!-- æ´»åŠ¨ç±»å‹åˆ†å¸ƒå›¾ -->
            <div class="layui-col-md6">
                <div class="chart-container">
                    <h3>æ´»åŠ¨ç±»å‹åˆ†å¸ƒ</h3>
                    <div id="activityTypeChart" style="height: 300px;"></div>
                </div>
            </div>
            
            <!-- æœˆåº¦æœåŠ¡æ—¶é•¿è¶‹åŠ¿å›¾ -->
            <div class="layui-col-md6">
                <div class="chart-container">
                    <h3>æœˆåº¦æœåŠ¡æ—¶é•¿è¶‹åŠ¿</h3>
                    <div id="monthlyChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- å¿—æ„¿è€…æ’è¡Œæ¦œ -->
        <div class="chart-container">
            <h3>å¿—æ„¿è€…æœåŠ¡æ—¶é•¿æ’è¡Œæ¦œ</h3>
            <table id="volunteerRankTable" lay-filter="volunteerRankTable"></table>
        </div>

        <!-- æ´»åŠ¨å‚ä¸ç»Ÿè®¡ -->
        <div class="chart-container">
            <h3>æ´»åŠ¨å‚ä¸ç»Ÿè®¡</h3>
            <table id="activityStatsTable" lay-filter="activityStatsTable"></table>
        </div>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        layui.use(['table', 'form', 'layer', 'laydate'], function(){
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var laydate = layui.laydate;
            var $ = layui.$;

            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
            laydate.render({
                elem: '#startDate',
                type: 'date'
            });
            laydate.render({
                elem: '#endDate',
                type: 'date'
            });

            // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
            loadStatistics();

            // æœç´¢åŠŸèƒ½
            form.on('submit(search)', function(data){
                loadStatistics(data.field);
                return false;
            });

            // åŠ è½½ç»Ÿè®¡æ•°æ®
            function loadStatistics(searchParams = {}) {
                $.ajax({
                    url: '/statistics/dashboard',
                    type: 'GET',
                    data: searchParams,
                    success: function(res){
                        if(res.code === 200){
                            updateStatisticsCards(res.data);
                            updateActivityTypeChart(res.data.activity_type_stats);
                            updateMonthlyChart(res.data.monthly_stats);
                            loadVolunteerRanking(searchParams);
                            loadActivityStats(searchParams);
                        } else {
                            layer.msg(res.msg || 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥', {icon: 2});
                        }
                    }
                });
            }

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
            function updateStatisticsCards(data) {
                $('#totalVolunteers').text(data.total_volunteers || 0);
                $('#totalActivities').text(data.total_activities || 0);
                $('#totalServiceHours').text(data.total_service_hours || 0);
                $('#completedActivities').text(data.completed_activities || 0);
            }

            // æ›´æ–°æ´»åŠ¨ç±»å‹åˆ†å¸ƒå›¾
            function updateActivityTypeChart(data) {
                var chartDom = document.getElementById('activityTypeChart');
                var myChart = echarts.init(chartDom);
                
                var option = {
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left'
                    },
                    series: [
                        {
                            name: 'æ´»åŠ¨ç±»å‹',
                            type: 'pie',
                            radius: '50%',
                            data: data.map(function(item) {
                                return {
                                    name: item.activity_type,
                                    value: item.count
                                };
                            }),
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
                
                myChart.setOption(option);
            }

            // æ›´æ–°æœˆåº¦æœåŠ¡æ—¶é•¿è¶‹åŠ¿å›¾
            function updateMonthlyChart(data) {
                var chartDom = document.getElementById('monthlyChart');
                var myChart = echarts.init(chartDom);
                
                var option = {
                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category',
                        data: data.map(function(item) { return item.month; })
                    },
                    yAxis: {
                        type: 'value',
                        name: 'æœåŠ¡æ—¶é•¿(å°æ—¶)'
                    },
                    series: [{
                        name: 'æœåŠ¡æ—¶é•¿',
                        type: 'line',
                        data: data.map(function(item) { return item.total_hours; }),
                        smooth: true,
                        itemStyle: {
                            color: '#5FB878'
                        }
                    }]
                };
                
                myChart.setOption(option);
            }

            // åŠ è½½å¿—æ„¿è€…æ’è¡Œæ¦œ
            function loadVolunteerRanking(searchParams) {
                table.render({
                    elem: '#volunteerRankTable',
                    url: '/statistics/volunteer_ranking',
                    data: [],
                    beforeSend: function(xhr) {
                        // åœ¨å‘é€è¯·æ±‚å‰è®¾ç½®è®¤è¯å¤´
                        xhr.setRequestHeader('Authorization', 'Bearer ' + window.AUTH_TOKEN);
                    },
                    cols: [[
                        {field: 'rank', title: 'æ’å', width: 80, templet: function(d){
                            var rank = d.LAY_TABLE_INDEX + 1;
                            if(rank === 1) return '<span style="color: #FFD700;">ğŸ¥‡</span>';
                            if(rank === 2) return '<span style="color: #C0C0C0;">ğŸ¥ˆ</span>';
                            if(rank === 3) return '<span style="color: #CD7F32;">ğŸ¥‰</span>';
                            return rank;
                        }},
                        {field: 'real_name', title: 'å¿—æ„¿è€…å§“å', width: 120},
                        {field: 'volunteer_level', title: 'ç­‰çº§', width: 100},
                        {field: 'total_activities', title: 'å‚ä¸æ´»åŠ¨æ•°', width: 120, sort: true},
                        {field: 'total_service_hours', title: 'æœåŠ¡æ—¶é•¿(å°æ—¶)', width: 150, sort: true},
                        {field: 'last_activity_date', title: 'æœ€è¿‘æ´»åŠ¨', width: 180}
                    ]],
                    page: false,
                    request: {
                        pageName: 'page',
                        limitName: 'limit'
                    },
                    response: {
                        statusName: 'code',
                        statusCode: 0,
                        msgName: 'msg',
                        countName: 'count',
                        dataName: 'data'
                    },
                    parseData: function(res){
                        console.log('å¿—æ„¿è€…æ’è¡Œæ¦œAPIå“åº”:', res);
                        return {
                            "code": res.code,
                            "msg": res.msg,
                            "count": res.count,
                            "data": res.data
                        };
                    }
                });
            }

            // åŠ è½½æ´»åŠ¨ç»Ÿè®¡
            function loadActivityStats(searchParams) {
                table.render({
                    elem: '#activityStatsTable',
                    url: '/statistics/activity_stats',
                    data: [],
                    beforeSend: function(xhr) {
                        // åœ¨å‘é€è¯·æ±‚å‰è®¾ç½®è®¤è¯å¤´
                        xhr.setRequestHeader('Authorization', 'Bearer ' + window.AUTH_TOKEN);
                    },
                    cols: [[
                        {field: 'activity_name', title: 'æ´»åŠ¨åç§°', width: 200},
                        {field: 'activity_type', title: 'æ´»åŠ¨ç±»å‹', width: 120},
                        {field: 'participant_count', title: 'å‚ä¸äººæ•°', width: 100, sort: true},
                        {field: 'total_hours', title: 'æ€»æœåŠ¡æ—¶é•¿', width: 120, sort: true},
                        {field: 'avg_hours', title: 'äººå‡æ—¶é•¿', width: 100, sort: true},
                        {field: 'start_date', title: 'å¼€å§‹æ—¥æœŸ', width: 120},
                        {field: 'status', title: 'çŠ¶æ€', width: 100}
                    ]],
                    page: true,
                    request: {
                        pageName: 'page',
                        limitName: 'limit'
                    },
                    response: {
                        statusName: 'success',
                        statusCode: true
                    },
                    parseData: function(res){
                        console.log('æ´»åŠ¨ç»Ÿè®¡APIå“åº”:', res); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        return {
                            "code": res.success === true ? 0 : 1,
                            "msg": res.msg || (res.success ? 'ok' : 'error'),
                            "count": res.count || res.total || 0,  // ä¼˜å…ˆä½¿ç”¨countå­—æ®µ
                            "data": res.data || []
                        };
                    }
                });
            }

            // å¯¼å‡ºExcel
            $('#exportExcel').on('click', function(){
                var searchData = form.val('searchForm');
                var params = new URLSearchParams(searchData);
                window.open('/statistics/export_excel?' + params.toString());
            });

            // å¯¼å‡ºPDF
            $('#exportPDF').on('click', function(){
                var searchData = form.val('searchForm');
                var params = new URLSearchParams(searchData);
                window.open('/statistics/export_pdf?' + params.toString());
            });
        });
    </script>
</body>
</html>
