<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>人员管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="/static/layui/css/layui.css" media="all">
    <style>
        .layui-form-item {
            display: flex;
        }

        .layui-form-label {
            width: 120px;
        }

        .layui-input-block {
            margin-left: 0;
            margin-right: 20px;
            width: 100%;
        }
    </style>
</head>

<body>

    <div class="layui-form" lay-filter="layui-form-pd" style="padding: 20px 0 0 0;">
        <div class="layui-form-item" id="nick_name">
            <label class="layui-form-label">名称</label>
            <div class="layui-input-block">
                <input type="text" name="nick_name" lay-verify="required" placeholder="请输入名称" autocomplete="off"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input type="text" name="phone" lay-verify="required|phone" placeholder="请输入手机号" autocomplete="off"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input type="text" name="email" lay-verify="email" placeholder="请输入邮箱" autocomplete="off"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">登录名</label>
            <div class="layui-input-block">
                <input type="text" name="username" lay-verify="required" placeholder="请输入登录名" autocomplete="off"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" id="password">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-block">
                <input type="password" name="password" lay-verify="required" placeholder="请输入密码" autocomplete="off"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">生日</label>
            <div class="layui-input-block">
                <input type="text" name="birthday" class="layui-input" lay-verify="required" id="ID-laydate-demo"
                    placeholder="yyyy-MM-dd">
            </div>
        </div>
        <div class="layui-form-item" lay-filter="gender">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <input type="radio" name="gender" value="1" title="男" checked>
                <input type="radio" name="gender" value="0" title="女">
            </div>
        </div>
        <div class="layui-form-item" lay-filter="status">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <input type="radio" name="status" value="1" title="正常" checked>
                <input type="radio" name="status" value="0" title="禁用">
            </div>
        </div>
        <div class="layui-form-item" lay-filter="role_ids">
            <label class="layui-form-label">角色</label>
            <div class="layui-input-block">
                <div id='role_ids'>
                </div>
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <input type="button" lay-submit lay-filter="layui-form-pd" id="layui-form-pd" value="确认">
        </div>
    </div>

    <script src="/static/layui/layui.js"></script>
    <script src="/static/js/xm-select.js"></script>
    <script>
        layui.config({
            base: '/static/' //静态资源所在路径
        }).extend({
            index: 'lib/index',
        }).use(['index', 'form', 'upload', 'laydate'], function () {
            var $ = layui.$
                , form = layui.form;
            var laydate = layui.laydate;
            // 渲染
            laydate.render({
                elem: '#ID-laydate-demo'
            });
            // 加载角色数据
            function loadRoles(userId) {
                $.ajax({
                    type: "get",
                    url: `/role/auth_role?user_id=${userId || ''}`,
                    contentType: 'application/json;charset=utf-8',
                    processData: false,
                    dataType: "json",
                    success: function (result) {
                        if (result.success) {
                            const role_ids = userId ? result.data.role_ids.map(v=>v.role_id) : []
                            const roles = result.data.roles
                            var demo1 = xmSelect.render({
                                el: '#role_ids',
                                language: 'zn',
                                name: 'role_ids',
                                layVerify: 'required',
                                layVerType: '请选择角色',
                                data: roles.map(v=>{
                                    return {
                                        name: v.role_name,
                                        value: v.id,
                                        selected: role_ids.includes(v.id)
                                    }
                                })
                            })
                        } else {
                        }
                    },
                    error: function (data) {
                        layer.msg("网络错误！");
                    }
                });
            }
            
            if (layui.getData()) {
                var data = layui.getData()
                if (data && data.id) {
                    // 编辑用户时，移除密码字段的必填验证
                    $("#password input").removeAttr('lay-verify');
                    form.val('layui-form-pd', JSON.parse(JSON.stringify(data)));
                }
                loadRoles(data.id);
            } else {
                // 添加新用户时加载角色，保持密码字段的必填验证
                loadRoles('');
            }

        })
    </script>
</body>

</html>