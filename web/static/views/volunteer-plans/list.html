<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>活动计划管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="/static/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="/static/style/admin.css" media="all">
  <style>
    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .page-header h2 {
      margin: 0;
      font-size: 24px;
    }
    .page-header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }
    .search-panel {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .toolbar {
      margin-bottom: 15px;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: white;
    }
    .status-draft { background-color: #6c757d; }
    .status-pending { background-color: #fd7e14; }
    .status-approved { background-color: #28a745; }
    .status-rejected { background-color: #dc3545; }
    .status-ongoing { background-color: #007bff; }
    .status-completed { background-color: #17a2b8; }
    .status-cancelled { background-color: #343a40; }
  </style>
</head>
<body>
  <div class="layui-fluid">
    <!-- 页面头部 -->
    <div class="page-header">
      <h2><i class="layui-icon layui-icon-trademark"></i> 活动计划管理</h2>
      <p>创建和管理志愿者活动计划，支持活动全生命周期管理</p>
    </div>

    <div class="layui-card">
      <div class="layui-card-body">
        <!-- 搜索面板 -->
        <div class="search-panel">
          <form class="layui-form" lay-filter="searchForm">
            <div class="layui-form-item">
              <div class="layui-inline">
                <label class="layui-form-label">活动名称</label>
                <div class="layui-input-inline">
                  <input type="text" name="activity_name" placeholder="请输入活动名称" autocomplete="off" class="layui-input">
                </div>
              </div>
              <div class="layui-inline">
                <label class="layui-form-label">活动类型</label>
                <div class="layui-input-inline">
                  <select name="activity_type" lay-search>
                    <option value="">请选择活动类型</option>
                  </select>
                </div>
              </div>
              <div class="layui-inline">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-inline">
                  <select name="status">
                    <option value="">全部状态</option>
                    <option value="draft">草稿</option>
                    <option value="pending">待审核</option>
                    <option value="approved">已通过</option>
                    <option value="rejected">已拒绝</option>
                    <option value="ongoing">进行中</option>
                    <option value="completed">已完成</option>
                    <option value="cancelled">已取消</option>
                  </select>
                </div>
              </div>
              <div class="layui-inline">
                <button class="layui-btn" lay-submit lay-filter="search">
                  <i class="layui-icon layui-icon-search"></i> 搜索
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
              </div>
            </div>
          </form>
        </div>

        <!-- 工具栏 -->
        <div class="toolbar">
          <button class="layui-btn" id="addBtn">
            <i class="layui-icon layui-icon-add-1"></i> 新增活动
          </button>
          <button class="layui-btn layui-btn-normal" id="exportBtn" style="display: none;">
            <i class="layui-icon layui-icon-export"></i> 导出数据
          </button>
          <button class="layui-btn layui-btn-danger" id="batchDeleteBtn">
            <i class="layui-icon layui-icon-delete"></i> 批量删除
          </button>
        </div>

        <!-- 数据表格 -->
        <table class="layui-hide" id="dataTable" lay-filter="dataTable"></table>
      </div>
    </div>
  </div>

  <!-- 表格操作列模板 - 管理员版本（包含审核按钮） -->
  <script type="text/html" id="tableToolbarAdmin">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="audit">审核</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
  </script>

  <!-- 表格操作列模板 - 普通用户版本（不包含审核按钮） -->
  <script type="text/html" id="tableToolbarUser">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
  </script>

  <!-- 表格操作列模板（兼容旧版本） -->
  <script type="text/html" id="operationTpl">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看</a>
    <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="audit">审核</a>
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
  </script>

  <!-- 状态列模板 -->
  <script type="text/html" id="statusTpl">
    {{# if(d.status === 'draft'){ }}
      <span class="status-badge status-draft">草稿</span>
    {{# } else if(d.status === 'pending'){ }}
      <span class="status-badge status-pending">待审核</span>
    {{# } else if(d.status === 'approved'){ }}
      <span class="status-badge status-approved">已通过</span>
    {{# } else if(d.status === 'rejected'){ }}
      <span class="status-badge status-rejected">已拒绝</span>
    {{# } else if(d.status === 'ongoing'){ }}
      <span class="status-badge status-ongoing">进行中</span>
    {{# } else if(d.status === 'completed'){ }}
      <span class="status-badge status-completed">已完成</span>
    {{# } else if(d.status === 'cancelled'){ }}
      <span class="status-badge status-cancelled">已取消</span>
    {{# } }}
  </script>

  <!-- 新增/编辑表单弹窗 -->
  <div id="formModal" style="display: none; padding: 20px;">
    <form class="layui-form" lay-filter="formFilter">
      <div class="layui-form-item">
        <label class="layui-form-label">活动名称</label>
        <div class="layui-input-block">
          <input type="text" name="activity_name" required lay-verify="required" placeholder="请输入活动名称" autocomplete="off" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">活动类型</label>
        <div class="layui-input-block">
          <select name="activity_type" lay-verify="required" lay-search>
            <option value="">请选择活动类型</option>
          </select>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">活动日期</label>
        <div class="layui-input-block">
          <input type="text" name="activity_date" id="activity_date" required lay-verify="required" placeholder="请选择活动日期" autocomplete="off" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">活动地点</label>
        <div class="layui-input-block">
          <input type="text" name="location" required lay-verify="required" placeholder="请输入活动地点" autocomplete="off" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">服务时长</label>
        <div class="layui-input-inline">
          <input type="number" name="service_hours" required lay-verify="required" placeholder="小时" autocomplete="off" class="layui-input" step="0.5" min="0.5">
        </div>
        <div class="layui-form-mid layui-word-aux">小时</div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">最大人数</label>
        <div class="layui-input-inline">
          <input type="number" name="max_participants" required lay-verify="required" placeholder="人数" autocomplete="off" class="layui-input" min="1">
        </div>
        <div class="layui-form-mid layui-word-aux">人</div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">参与要求</label>
        <div class="layui-input-block">
          <textarea name="requirements" placeholder="请输入参与要求" class="layui-textarea"></textarea>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">活动福利</label>
        <div class="layui-input-block">
          <textarea name="benefits" placeholder="请输入活动福利" class="layui-textarea"></textarea>
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">联系人</label>
        <div class="layui-input-block">
          <input type="text" name="contact_person" placeholder="请输入联系人姓名" autocomplete="off" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">联系电话</label>
        <div class="layui-input-block">
          <input type="text" name="contact_phone" placeholder="请输入联系电话" autocomplete="off" class="layui-input">
        </div>
      </div>

      <div class="layui-form-item">
        <label class="layui-form-label">备注</label>
        <div class="layui-input-block">
          <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea>
        </div>
      </div>

      <div class="layui-form-item">
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="formSubmit">提交</button>
          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
      </div>
    </form>
  </div>

  <!-- 查看详情弹窗 -->
  <div id="viewModal" style="display: none; padding: 20px;">
    <div class="layui-card">
      <div class="layui-card-header">
        <h3 id="viewTitle">活动详情</h3>
      </div>
      <div class="layui-card-body" id="viewContent">
        <!-- 详情内容将通过JavaScript动态填充 -->
      </div>
    </div>
  </div>

  <script src="/static/layui/layui.js"></script>
  <script>
    layui.use(['table', 'form', 'layer', 'laydate'], function () {
      var table = layui.table;
      var form = layui.form;
      var layer = layui.layer;
      var laydate = layui.laydate;
      var $ = layui.$;

      // 初始化日期选择器
      laydate.render({
        elem: '#activity_date',
        type: 'datetime'
      });

      // 加载活动类型数据
      function loadActivityTypes() {
        fetch('/activity_type/list')
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              var options = '<option value="">请选择活动类型</option>';
              result.data.forEach(function(item) {
                options += '<option value="' + item.type_name + '">' + item.type_name + '</option>';
              });
              $('select[name="activity_type"]').html(options);
              form.render('select');
            }
          })
          .catch(error => {
            console.error('加载活动类型失败:', error);
          });
      }

      // 初始化表格
      var tableIns = table.render({
        elem: '#dataTable',
        url: '/volunteer_plans/page',
        method: 'get',
        beforeSend: function(xhr) {
          // 在发送请求前设置认证头
          xhr.setRequestHeader('Authorization', 'Bearer ' + window.AUTH_TOKEN);
        },
        toolbar: true,
        defaultToolbar: ['filter', 'exports', 'print'],
        cols: [[
          {type: 'checkbox', fixed: 'left'},
          {field: 'activity_name', title: '活动名称', width: 200, fixed: 'left'},
          {field: 'activity_type', title: '活动类型', width: 120},
          {field: 'activity_date', title: '活动日期', width: 160},
          {field: 'location', title: '活动地点', width: 150},
          {field: 'service_hours', title: '服务时长', width: 100},
          {field: 'max_participants', title: '最大人数', width: 100},
          {field: 'current_participants', title: '当前人数', width: 100},
          {field: 'status', title: '状态', width: 100, templet: '#statusTpl'},
          {field: 'user_name', title: '创建人', width: 100},
          {field: 'created_at', title: '创建时间', width: 160},
          {title: '操作', width: 280, toolbar: '#operationTpl', fixed: 'right'}
        ]],
        page: true,
        limit: 20,
        limits: [10, 20, 50, 100],
        height: 'full-200',
        text: {
          none: '暂无数据'
        },
        response: {
          statusName: 'code',
          statusCode: 0,
          msgName: 'msg',
          countName: 'count',
          dataName: 'data'
        },
        parseData: function(res) {
          console.log('API Response:', res);
          return {
            code: res.code,
            msg: res.msg,
            count: res.count,
            data: res.data
          };
        }
      });

      // 搜索功能
      form.on('submit(search)', function (data) {
        tableIns.reload({
          where: data.field,
          page: {curr: 1}
        });
        return false;
      });

      // 新增按钮事件
      $('#addBtn').on('click', function () {
        showFormModal();
      });

      // 导出按钮事件（已隐藏，保留逻辑以防后续需要）
      $('#exportBtn').on('click', function () {
        layer.msg('导出功能开发中...', {icon: 1});
      });

      // 显示表单弹窗
      function showFormModal(data) {
        layer.open({
          type: 1,
          title: data ? '编辑活动' : '新增活动',
          area: ['700px', '600px'],
          content: $('#formModal'),
          success: function () {
            if (data) {
              form.val('formFilter', data);
            } else {
              form.val('formFilter', {});
            }
          }
        });
      }

      // 显示查看弹窗
      function showViewModal(data) {
        var content = `
          <table class="layui-table" lay-skin="line">
            <tr><td width="120">活动名称：</td><td>${data.activity_name || '-'}</td></tr>
            <tr><td>活动类型：</td><td>${data.activity_type || '-'}</td></tr>
            <tr><td>活动日期：</td><td>${data.activity_date || '-'}</td></tr>
            <tr><td>活动地点：</td><td>${data.location || '-'}</td></tr>
            <tr><td>服务时长：</td><td>${data.service_hours || '-'} 小时</td></tr>
            <tr><td>最大人数：</td><td>${data.max_participants || '-'} 人</td></tr>
            <tr><td>当前人数：</td><td>${data.current_participants || '-'} 人</td></tr>
            <tr><td>状态：</td><td>${getStatusText(data.status)}</td></tr>
            <tr><td>参与要求：</td><td>${data.requirements || '-'}</td></tr>
            <tr><td>活动福利：</td><td>${data.benefits || '-'}</td></tr>
            <tr><td>联系人：</td><td>${data.contact_person || '-'}</td></tr>
            <tr><td>联系电话：</td><td>${data.contact_phone || '-'}</td></tr>
            <tr><td>备注：</td><td>${data.remark || '-'}</td></tr>
            <tr><td>创建人：</td><td>${data.user_name || '-'}</td></tr>
            <tr><td>创建时间：</td><td>${data.created_at || '-'}</td></tr>
          </table>
        `;

        $('#viewContent').html(content);

        layer.open({
          type: 1,
          title: '活动详情',
          area: ['700px', '600px'],
          content: $('#viewModal')
        });
      }

      // 显示审核弹窗
      function showAuditModal(data) {
        var content = `
          <div style="padding: 20px;">
            <div class="layui-form" lay-filter="auditForm">
              <div class="layui-form-item">
                <label class="layui-form-label">活动名称</label>
                <div class="layui-input-block">
                  <input type="text" value="${data.activity_name || '-'}" readonly class="layui-input layui-disabled">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">活动类型</label>
                <div class="layui-input-block">
                  <input type="text" value="${data.activity_type || '-'}" readonly class="layui-input layui-disabled">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">活动日期</label>
                <div class="layui-input-block">
                  <input type="text" value="${data.activity_date || '-'}" readonly class="layui-input layui-disabled">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">活动地点</label>
                <div class="layui-input-block">
                  <input type="text" value="${data.location || '-'}" readonly class="layui-input layui-disabled">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">当前状态</label>
                <div class="layui-input-block">
                  <input type="text" value="${getStatusText(data.status)}" readonly class="layui-input layui-disabled">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">审核操作</label>
                <div class="layui-input-block">
                  <input type="radio" name="audit_action" value="approve" title="通过" checked>
                  <input type="radio" name="audit_action" value="reject" title="拒绝">
                </div>
              </div>
              <div class="layui-form-item">
                <label class="layui-form-label">审核意见</label>
                <div class="layui-input-block">
                  <textarea name="audit_remarks" placeholder="请输入审核意见" class="layui-textarea"></textarea>
                </div>
              </div>
              <div class="layui-form-item">
                <div class="layui-input-block">
                  <button class="layui-btn" lay-submit lay-filter="auditSubmit">提交审核</button>
                  <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">取消</button>
                </div>
              </div>
            </div>
          </div>
        `;

        layer.open({
          type: 1,
          title: '活动审核',
          area: ['600px', '500px'],
          content: content,
          success: function() {
            form.render();
          }
        });
      }

      // 获取状态文本
      function getStatusText(status) {
        var statusMap = {
          'draft': '草稿',
          'pending': '待审核',
          'approved': '已通过',
          'rejected': '已拒绝',
          'ongoing': '进行中',
          'completed': '已完成',
          'cancelled': '已取消'
        };
        return statusMap[status] || status;
      }

      // 表单提交
      form.on('submit(formSubmit)', function (data) {
        // 确保编辑时正确获取ID
        var recordId = data.field.id || (window.currentEditPlanId ? window.currentEditPlanId : null);
        var url = recordId ? '/volunteer_plans/update/' + recordId : '/volunteer_plans/add';
        var method = recordId ? 'PUT' : 'POST';

        var loading = layer.load(2);

        fetch(url, {
          method: method,
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data.field)
        })
        .then(response => response.json())
        .then(result => {
          layer.close(loading);
          if (result.success) {
            layer.closeAll();
            layer.msg('操作成功', {icon: 1});
            tableIns.reload();
          } else {
            layer.msg(result.msg || '操作失败', {icon: 2});
          }
        })
        .catch(error => {
          layer.close(loading);
          layer.msg('网络错误，请重试', {icon: 2});
          console.error('提交失败:', error);
        });

        return false;
      });

      // 审核表单提交
      form.on('submit(auditSubmit)', function (data) {
        var auditAction = data.field.audit_action;
        var auditRemarks = data.field.audit_remarks || '';
        var newStatus = auditAction === 'approve' ? 'approved' : 'rejected';

        var loading = layer.load(2);

        // 更新活动状态
        fetch('/volunteer_plans/status/' + window.currentAuditPlanId, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (window.AUTH_TOKEN || '')
          },
          body: JSON.stringify({
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(result => {
          layer.close(loading);
          if (result.success) {
            layer.closeAll();
            layer.msg('审核成功', {icon: 1});
            tableIns.reload();
          } else {
            layer.msg(result.msg || '审核失败', {icon: 2});
          }
        })
        .catch(error => {
          layer.close(loading);
          layer.msg('网络错误，请重试', {icon: 2});
          console.error('审核失败:', error);
        });

        return false;
      });

      // 表格行工具事件
      table.on('tool(dataTable)', function (obj) {
        var data = obj.data;

        if (obj.event === 'edit') {
          window.currentEditPlanId = data.id; // 保存当前编辑的ID
          showFormModal(data);
        } else if (obj.event === 'view') {
          showViewModal(data);
        } else if (obj.event === 'audit') {
          window.currentAuditPlanId = data.id; // 保存当前审核的活动ID
          showAuditModal(data);
        } else if (obj.event === 'del') {
          layer.confirm('确定删除此活动吗？', function (index) {
            var loading = layer.load(2);

            fetch('/volunteer_plans/delete/' + data.id, {method: 'DELETE'})
              .then(response => response.json())
              .then(result => {
                layer.close(loading);
                if (result.success) {
                  obj.del();
                  layer.msg('删除成功', {icon: 1});
                } else {
                  layer.msg(result.msg || '删除失败', {icon: 2});
                }
              })
              .catch(error => {
                layer.close(loading);
                layer.msg('网络错误，请重试', {icon: 2});
                console.error('删除失败:', error);
              });
            layer.close(index);
          });
        }
      });

      // 批量删除
      $('#batchDeleteBtn').on('click', function () {
        var checkStatus = table.checkStatus('dataTable');
        var data = checkStatus.data;

        if (data.length === 0) {
          layer.msg('请选择要删除的数据', {icon: 2});
          return;
        }

        layer.confirm('确定删除选中的 ' + data.length + ' 条数据吗？', function (index) {
          var loading = layer.load(2);
          var promises = data.map(function(item) {
            return fetch('/volunteer_plans/delete/' + item.id, {method: 'DELETE'});
          });

          Promise.all(promises).then(function() {
            layer.close(loading);
            layer.msg('批量删除成功', {icon: 1});
            tableIns.reload();
          }).catch(function() {
            layer.close(loading);
            layer.msg('批量删除失败', {icon: 2});
          });

          layer.close(index);
        });
      });

      // 获取当前用户信息
      function getCurrentUser() {
        return new Promise(function(resolve, reject) {
          $.ajax({
            url: '/myinfo',
            type: 'GET',
            success: function(result) {
              if (result.success) {
                resolve(result.data);
              } else {
                reject('获取用户信息失败');
              }
            },
            error: function() {
              reject('网络错误');
            }
          });
        });
      }

      // 检查用户是否有管理员权限
      function isAdmin(userData) {
        return userData && userData.role_ids && userData.role_ids.includes('300c55c2-a7ce-429f-bbce-56e102616746');
      }

      // 获取认证token
      function getToken() {
        return document.cookie.split(';').find(c => c.trim().startsWith('token='))?.split('=')[1];
      }

      // 页面加载完成后初始化
      $(function() {
        // 设置全局AUTH_TOKEN
        window.AUTH_TOKEN = getToken();

        loadActivityTypes();

        // 获取用户信息并根据权限显示审核按钮
        getCurrentUser().then(function(userData) {
          // 重新渲染表格，根据权限显示审核按钮
          tableIns.reload({
            cols: [[
              {type: 'checkbox', fixed: 'left'},
              {field: 'activity_name', title: '活动名称', width: 200, sort: true},
              {field: 'activity_type', title: '活动类型', width: 120},
              {field: 'activity_date', title: '活动日期', width: 160, sort: true},
              {field: 'location', title: '活动地点', width: 200},
              {field: 'service_hours', title: '服务时长', width: 100},
              {field: 'max_participants', title: '最大人数', width: 100},
              {field: 'current_participants', title: '当前人数', width: 100},
              {field: 'status', title: '状态', width: 100, templet: '#statusTpl'},
              {field: 'user_name', title: '创建人', width: 120},
              {field: 'created_at', title: '创建时间', width: 160, sort: true},
              {
                title: '操作',
                width: isAdmin(userData) ? 200 : 150,
                toolbar: isAdmin(userData) ? '#tableToolbarAdmin' : '#tableToolbarUser',
                fixed: 'right'
              }
            ]]
          });
        }).catch(function(error) {
          console.error('获取用户信息失败:', error);
        });
      });
    });
  </script>
</body>
</html>
