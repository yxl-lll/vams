<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>志愿者档案管理</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        .search-box { margin: 15px 0; }
        .table-toolbar { margin: 15px 0; }
        .status-normal { color: #5FB878; }
        .status-disabled { color: #FF5722; }
        .volunteer-level {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            color: white;
        }
        .level-bronze { background-color: #CD7F32; }
        .level-silver { background-color: #C0C0C0; }
        .level-gold { background-color: #FFD700; }
        .level-platinum { background-color: #E5E4E2; }
    </style>
</head>
<body>
<script>
    // 认证检查 - 页面加载时立即执行
    (function() {
        // 检查是否有有效的JWT token
        function getToken() {
            return document.cookie.split(';').find(c => c.trim().startsWith('token='))?.split('=')[1];
        }

        function checkAuth() {
            const token = getToken();
            if (!token) {
                // 没有token，重定向到登录页面
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // 页面加载时检查认证
        if (!checkAuth()) {
            return;
        }

        // 设置全局认证头
        window.AUTH_TOKEN = getToken();
    })();
</script>
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">
                <h3>志愿者档案管理</h3>
            </div>
            <div class="layui-card-body">
                <!-- 搜索框 -->
                <div class="search-box">
                    <form class="layui-form" lay-filter="searchForm">
                        <div class="layui-inline">
                            <input type="text" name="user_name" placeholder="请输入用户名" class="layui-input">
                        </div>
                        <div class="layui-inline">
                            <select name="volunteer_level">
                                <option value="">全部等级</option>
                                <option value="bronze">青铜</option>
                                <option value="silver">白银</option>
                                <option value="gold">黄金</option>
                                <option value="platinum">铂金</option>
                            </select>
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn" lay-submit lay-filter="search">搜索</button>
                            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                        </div>
                    </form>
                </div>

                <!-- 工具栏 -->
                <div class="table-toolbar">
                    <button class="layui-btn" id="addVolunteer">
                        <i class="layui-icon layui-icon-add-1"></i> 添加志愿者
                    </button>
                    <button class="layui-btn layui-btn-normal" id="exportData" style="display: none;">
                        <i class="layui-icon layui-icon-export"></i> 导出数据
                    </button>
                </div>

                <!-- 数据表格 -->
                <table id="volunteerTable" lay-filter="volunteerTable"></table>
            </div>
        </div>
    </div>

    <!-- 表格操作列模板 -->
    <script type="text/html" id="tableToolbar">
        <a class="layui-btn layui-btn-xs" lay-event="view">查看</a>
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>

    <!-- 志愿者等级模板 -->
    <script type="text/html" id="levelTpl">
        {{# if(d.volunteer_level === 'bronze') { }}
            <span class="volunteer-level level-bronze">青铜</span>
        {{# } else if(d.volunteer_level === 'silver') { }}
            <span class="volunteer-level level-silver">白银</span>
        {{# } else if(d.volunteer_level === 'gold') { }}
            <span class="volunteer-level level-gold">黄金</span>
        {{# } else if(d.volunteer_level === 'platinum') { }}
            <span class="volunteer-level level-platinum">铂金</span>
        {{# } else { }}
            <span class="volunteer-level level-bronze">青铜</span>
        {{# } }}
    </script>

    <!-- 状态列模板 -->
    <script type="text/html" id="statusTpl">
        {{# if(d.status == 1) { }}
            <span class="status-normal">正常</span>
        {{# } else { }}
            <span class="status-disabled">禁用</span>
        {{# } }}
    </script>

    <!-- 添加/编辑表单 -->
    <script type="text/html" id="volunteerForm">
        <form class="layui-form" lay-filter="volunteerForm" style="padding: 20px;">
            <div class="layui-form-item">
                <label class="layui-form-label">用户ID</label>
                <div class="layui-input-block">
                    <input type="text" name="user_id" required lay-verify="required" placeholder="请输入用户ID" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">用户名</label>
                <div class="layui-input-block">
                    <input type="text" name="user_name" required lay-verify="required" placeholder="请输入用户名" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">真实姓名</label>
                <div class="layui-input-block">
                    <input type="text" name="real_name" placeholder="请输入真实姓名" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">手机号</label>
                <div class="layui-input-block">
                    <input type="text" name="phone" lay-verify="phone" placeholder="请输入手机号" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">身份证号</label>
                <div class="layui-input-block">
                    <input type="text" name="id_card" lay-verify="identity" placeholder="请输入身份证号" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">性别</label>
                <div class="layui-input-block">
                    <input type="radio" name="gender" value="男" title="男" checked>
                    <input type="radio" name="gender" value="女" title="女">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">出生日期</label>
                <div class="layui-input-block">
                    <input type="text" name="birth_date" id="birthDate" placeholder="请选择出生日期" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">志愿者等级</label>
                <div class="layui-input-block">
                    <select name="volunteer_level">
                        <option value="">请选择等级</option>
                        <option value="bronze">青铜</option>
                        <option value="silver">白银</option>
                        <option value="gold">黄金</option>
                        <option value="platinum">铂金</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">技能标签</label>
                <div class="layui-input-block">
                    <input type="text" name="skills" placeholder="请输入技能标签，用逗号分隔" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">兴趣标签</label>
                <div class="layui-input-block">
                    <input type="text" name="interests" placeholder="请输入兴趣标签，用逗号分隔" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">加入日期</label>
                <div class="layui-input-block">
                    <input type="text" name="join_date" placeholder="请选择加入日期" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <input type="radio" name="status" value="1" title="正常" checked>
                    <input type="radio" name="status" value="0" title="禁用">
                </div>
            </div>
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-block">
                    <textarea name="remarks" placeholder="请输入备注信息" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="volunteerSubmit">提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </script>

    <script src="/static/layui/layui.js"></script>
    <script>
        layui.use(['table', 'form', 'layer', 'laydate'], function(){
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var laydate = layui.laydate;
            var $ = layui.$;

            // 初始化日期选择器
            laydate.render({
                elem: '#birthDate'
            });

            // 初始化加入日期选择器
            laydate.render({
                elem: 'input[name="join_date"]'
            });

            // 初始化表格
            var tableIns = table.render({
                elem: '#volunteerTable',
                url: '/volunteer_profile/list',
                page: true,
                beforeSend: function(xhr) {
                    // 在发送请求前设置认证头
                    xhr.setRequestHeader('Authorization', 'Bearer ' + window.AUTH_TOKEN);
                },
                cols: [[
                    {type: 'checkbox', fixed: 'left'},
                    {field: 'id', title: 'ID', width: 80, sort: true},
                    {field: 'real_name', title: '真实姓名', width: 120},
                    {field: 'phone', title: '手机号', width: 130},
                    {field: 'gender', title: '性别', width: 80},
                    {field: 'birth_date', title: '出生日期', width: 120},
                    {field: 'volunteer_level', title: '志愿者等级', width: 100, templet: '#levelTpl'},
                    {field: 'total_service_hours', title: '服务时长(小时)', width: 120, sort: true},
                    {field: 'status', title: '状态', width: 100, templet: '#statusTpl'},
                    {field: 'created_at', title: '创建时间', width: 180},
                    {title: '操作', width: 200, toolbar: '#tableToolbar', fixed: 'right'}
                ]],
                request: {
                    pageName: 'page',
                    limitName: 'limit'
                },
                response: {
                    statusName: 'code',
                    statusCode: 0,
                    msgName: 'msg',
                    countName: 'count',
                    dataName: 'data'
                },
                parseData: function(res){
                    console.log('志愿者档案API响应:', res); // 添加调试日志
                    return {
                        "code": res.code,
                        "msg": res.msg,
                        "count": res.count,
                        "data": res.data || []
                    };
                }
            });

            // 搜索功能
            form.on('submit(search)', function(data){
                tableIns.reload({
                    where: data.field,
                    page: {curr: 1}
                });
                return false;
            });

            // 添加志愿者
            $('#addVolunteer').on('click', function(){
                layer.open({
                    type: 1,
                    title: '添加志愿者',
                    area: ['600px', '600px'],
                    content: $('#volunteerForm').html(),
                    success: function(){
                        form.render();
                        laydate.render({
                            elem: '#birthDate'
                        });
                        laydate.render({
                            elem: 'input[name="join_date"]'
                        });
                    }
                });
            });

            // 表格工具栏事件
            table.on('tool(volunteerTable)', function(obj){
                var data = obj.data;
                if(obj.event === 'view'){
                    // 查看详情
                    layer.open({
                        type: 1,
                        title: '志愿者详情',
                        area: ['600px', '600px'],
                        content: '<div style="padding: 20px;">' +
                            '<p><strong>真实姓名：</strong>' + (data.real_name || '') + '</p>' +
                            '<p><strong>手机号：</strong>' + (data.phone || '') + '</p>' +
                            '<p><strong>身份证号：</strong>' + (data.id_card || '') + '</p>' +
                            '<p><strong>性别：</strong>' + (data.gender || '') + '</p>' +
                            '<p><strong>出生日期：</strong>' + (data.birth_date || '') + '</p>' +
                            '<p><strong>志愿者等级：</strong>' + (data.volunteer_level || '') + '</p>' +
                            '<p><strong>服务时长：</strong>' + (data.total_service_hours || 0) + '小时</p>' +
                            '<p><strong>备注：</strong>' + (data.remarks || '') + '</p>' +
                            '</div>'
                    });
                } else if(obj.event === 'edit'){
                    // 编辑
                    window.currentEditVolunteerId = data.id; // 保存当前编辑的ID
                    layer.open({
                        type: 1,
                        title: '编辑志愿者',
                        area: ['600px', '600px'],
                        content: $('#volunteerForm').html(),
                        success: function(){
                            form.val('volunteerForm', data);
                            form.render();
                            laydate.render({
                                elem: '#birthDate'
                            });
                            laydate.render({
                                elem: 'input[name="join_date"]'
                            });
                        }
                    });
                } else if(obj.event === 'del'){
                    // 删除
                    layer.confirm('确定删除此志愿者档案吗？', function(index){
                        $.ajax({
                            url: '/volunteer_profile/delete/' + data.id,
                            type: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + window.AUTH_TOKEN
                            },
                            success: function(res){
                                if(res.code === 200){
                                    layer.msg('删除成功', {icon: 1});
                                    obj.del();
                                } else {
                                    layer.msg(res.msg || '删除失败', {icon: 2});
                                }
                            },
                            error: function(xhr, status, error) {
                                console.log('删除请求错误:', xhr.responseText);
                                var errorMsg = '删除失败';

                                // 处理认证失败
                                if (xhr.status === 401 || xhr.status === 307) {
                                    layer.msg('认证失败，请重新登录', {icon: 2}, function() {
                                        window.location.href = '/login';
                                    });
                                    return;
                                }

                                try {
                                    var errorData = JSON.parse(xhr.responseText);
                                    errorMsg = errorData.detail || errorMsg;
                                } catch(e) {
                                    errorMsg = xhr.responseText || errorMsg;
                                }
                                layer.msg('错误: ' + errorMsg, {icon: 2});
                            }
                        });
                        layer.close(index);
                    });
                }
            });

            // 表单提交
            form.on('submit(volunteerSubmit)', function(data){
                console.log('表单数据:', data.field); // 调试日志

                // 验证必填字段
                if (!data.field.user_id || !data.field.user_id.trim()) {
                    layer.msg('用户ID不能为空', {icon: 2});
                    return false;
                }
                if (!data.field.user_name || !data.field.user_name.trim()) {
                    layer.msg('用户名不能为空', {icon: 2});
                    return false;
                }

                // 检查认证token
                if (!window.AUTH_TOKEN) {
                    layer.msg('认证失败，请重新登录', {icon: 2}, function() {
                        window.location.href = '/login';
                    });
                    return false;
                }

                // 转换数据为JSON格式
                var formData = {
                    user_id: data.field.user_id,
                    user_name: data.field.user_name,
                    real_name: data.field.real_name || null,
                    phone: data.field.phone || null,
                    id_card: data.field.id_card || null,
                    gender: data.field.gender || '男',
                    birth_date: data.field.birth_date || null,
                    skills: data.field.skills || null,
                    interests: data.field.interests || null,
                    volunteer_level: data.field.volunteer_level || 'bronze',
                    join_date: data.field.join_date || null,
                    status: parseInt(data.field.status) || 1,
                    remarks: data.field.remarks || null
                };

                console.log('转换后的JSON数据:', formData); // 调试日志

                // 检查是添加还是更新操作
                var recordId = data.field.id || (window.currentEditVolunteerId ? window.currentEditVolunteerId : null);
                var isEdit = recordId && recordId.trim() !== '';
                var url = isEdit ? '/volunteer_profile/update/' + recordId : '/volunteer_profile/add';

                // 如果是添加操作，先检查用户ID是否已存在
                if (!isEdit) {
                    // 先检查用户ID是否已存在
                    $.ajax({
                        url: '/volunteer_profile/user/' + encodeURIComponent(data.field.user_id),
                        type: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + window.AUTH_TOKEN
                        },
                        success: function(checkRes) {
                            if (checkRes.code === 200 && checkRes.data) {
                                layer.msg('该用户ID已存在，请使用其他用户ID', {icon: 2});
                                return;
                            }
                            // 用户ID不存在，继续提交
                            submitVolunteerData();
                        },
                        error: function() {
                            // 查询失败，继续提交（可能是网络问题）
                            submitVolunteerData();
                        }
                    });
                } else {
                    // 更新操作，直接提交
                    submitVolunteerData();
                }

                function submitVolunteerData() {
                    var method = isEdit ? 'PUT' : 'POST';
                    $.ajax({
                        url: url,
                        type: method,
                        data: JSON.stringify(formData),
                        contentType: 'application/json',
                        dataType: 'json',
                        headers: {
                            'Authorization': 'Bearer ' + window.AUTH_TOKEN  // 添加认证头
                        },
                        success: function(res){
                            if(res.code === 200){
                                layer.msg('操作成功', {icon: 1});
                                layer.closeAll();
                                tableIns.reload();
                            } else {
                                console.log('提交失败:', res); // 调试日志
                                // 处理特定的错误情况
                                if (res.msg === 'err') {
                                    layer.msg('操作失败：可能是用户ID已存在或其他数据冲突', {icon: 2});
                                } else {
                                    layer.msg(res.msg || '操作失败', {icon: 2});
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log('请求错误:', xhr.responseText); // 调试日志
                            var errorMsg = '网络错误，请稍后重试';

                            // 处理认证失败
                            if (xhr.status === 401 || xhr.status === 307) {
                                layer.msg('认证失败，请重新登录', {icon: 2}, function() {
                                    window.location.href = '/login';
                                });
                                return;
                            }

                            try {
                                var errorData = JSON.parse(xhr.responseText);
                                errorMsg = errorData.detail || errorMsg;
                            } catch(e) {
                                errorMsg = xhr.responseText || errorMsg;
                            }
                            layer.msg('错误: ' + errorMsg, {icon: 2});
                        }
                    });
                }

                return false;
            });

            // 导出数据（已隐藏，保留逻辑以防后续需要）
            $('#exportData').on('click', function(){
                var searchData = form.val('searchForm');
                var params = new URLSearchParams(searchData);
                window.open('/volunteer_profile/export?' + params.toString());
            });
        });
    </script>

    <script>
        // 页面加载时检查认证状态
        (function() {
            // 从cookie获取token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            // 获取token
            const token = getCookie('token');
            if (!token) {
                // 如果没有token，跳转到登录页
                window.location.href = '/login';
                return;
            }

            // 设置全局AUTH_TOKEN
            window.AUTH_TOKEN = token;
            console.log('认证token已设置');
        })();
    </script>
</body>
</html>
